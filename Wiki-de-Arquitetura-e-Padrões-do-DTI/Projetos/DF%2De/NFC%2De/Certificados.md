[[_TOC_]]

# Comandos para limpeza de cache CRL

## Cache em Disco:​
- abrir um cmd como Network Service:
` psexec -i -u "nt authority\network service" cmd.exe​ `

- rodar o seguinte comando:
` certutil -urlcache [caminho completo da crl] delete `

## Cache em Memória:​
- abrir um cmd como Administrator e rodar o seguinte comando:
 ` certutil -setreg chain\ChainCacheResyncFiletime @now `

## Comando powershell para listar todos os certificados na máquina:​
exemplos:

> get-childitem -Path cert: -Recurse | <font color="green">select Subject</font> |  <font color="purple">Select-String -Pattern .*Homolog.* </font> 

> get-childitem -Path cert: -Recurse | <font color="green">select Thumbprint,NotAfter</font> |  <font color="purple">Select-String -Pattern 5A70.*E47 </font> 

A parte <font color="green">verde</font> é somente se quiser filtrar quais campos serão mostrados.
A parte <font color="purple">roxa</font> é somente se quiser filtrar quais certificados serão mostrados. 

Itens possíveis na parte <font color="green">verde</font>:
<font color="green">Location, StoreNames, Name, Subject, Issuer, Thumbprint, FriendlyName, NotBefore, NotAfter, Extensions</font>

Na parte <font color="purple">roxa</font>, usar ExpressãoRegular padrão (no exemplo, o ponto significa "qualquer caracter" e o asterisco significa "qualquer quantidade").


# Interpretando os campos CNPJ, CPF, etc de um certificado:

`otherName.1                 = 2.16.76.1.3.4`
`otherName.2                 = 2.16.76.1.3.2`
`otherName.3                 = 2.16.76.1.3.3`

`otherName.1`: nas primeiras 8 (oito) posições, a data de nascimento do responsável pelo certificado, no formato ddmmaaaa; nas 11 (onze) posições subseqüentes, o Cadastro de Pessoa Física (CPF) do responsável
`otherName.2`: nome do responsável
`otherName.3`: CNPJ

Os dados aparecem como ASCII HEXA

Exemplo:

`Outro Nome:  2.16.76.1.3.4=0c 2d 30 31 30 31 31 39 38 30 31 33 32 30 37 39 35 31 38 38 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30`

`Outro Nome:  2.16.76.1.3.2=0c 0b 43 68 69 63 6f 20 42 6f 6f 6b 73`

`Outro Nome:  2.16.76.1.3.3=0c 0e 30 31 32 31 35 39 31 31 30 30 30 31 30 37`
​
Usando conversor de HEXA para ASCII (buscar no Google, existem diversos sites):

`0c 2d 30 31 30 31 31 39 38 30 31 33 32 30 37 39 35 31 38 38 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 = 010119801320795188000000000000000000000000000`

`01011980 13207951880 00000000000000000000000000`

Data de nascimento: 1-1-1980
CPF: 132.079.518-80

# Criação de certificados de teste
Atualmente, os certificados são todos criados pela equipe DTI-Segurança, através de chamado específico no Remedy.

Os certificados podem ser encontrados na solution:

MonitorEPEC: https://ads.intra.fazenda.sp.gov.br/tfs/TPC-2010/NFC-e/_versionControl?path=%24%2FNFC-e%2FMain%2FNFCe%2FLibs%2FNFCeCertificado%2FApp_Data

EmpresaFake e Empresa de Testes: https://ads.intra.fazenda.sp.gov.br/tfs/TPC-2010/NFC-e/_versionControl?path=%24%2FNFC-e%2FMain%2FNFCe%2FTestes%2FAssinadorNFCe%2FApp_Data

# Criação interna de certificados de teste (deprecated)

Até 2015, era possível que desenvolvedores criassem seus próprios certificados de teste (auto-assinados). A documentação abaixo era usada para esse tipo de certificado. Atualmente, os certificados auto-assinados não são aceitos pela política de segunrança do DTI. Mas a documentação abaixo pode servir para alguma situação futura.

## I) copiar, descompactar e instalar o script de criação de certificados:
[gerador_certificados_sefaz_v2.zip](/.attachments/gerador_certificados_sefaz_v2-b1ce5e94-6ca7-4b1d-b5ad-1df87f0c3fc6.zip)

#### Requisitos para executar o script gerador de certificados:
[Win32OpenSSL-1_0_0g.zip](/.attachments/Win32OpenSSL-1_0_0g-8d500ac4-e218-4d1e-a632-fbf9e0ca7ca0.zip)
[vcredist_x86.zip](/.attachments/vcredist_x86-2a11f6a7-6afa-48dd-ad1f-1a220e8b90ea.zip)
<A  href="http://etc.intra.fazenda.sp.gov.br/sites/cds_equipe/carga_desempenho_NFCe/strawberry-perl-5.14.2.1-32bit.zip" > strawberry-perl-5.14.2.1-32bit.zip</A> (link para etc porque a Wiki nova não suporta arquivos com mais de 18 MB)

<DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><STRONG>II) Para gerar certificados finais</STRONG></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">1) seguir os passos no arquivo "roteiro de geração de certificados A1.txt" que está dentro da pasta "sefaz" (no zip gerador_certificados_sefaz_v2.zip)), usando o comando</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN  class="ms-rteFontFace-2" style="font-family: courier, monospace"></SPAN><SPAN  class="ms-rteFontFace-2" style="font-family: courier, monospace">perl CA-cnpj.pl -newcert &lt;CNPJ sem traços ou  pontos&gt;</SPAN><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">2) renomear e copiar o certificado final gerado dentro da pasta "C:\OpenSSL-Win32\bin\sefaz\certificados\p12" nomeado como &lt;CNPJ&gt;.p12</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><STRONG>III) Para gerar certificados de AC intermediária</STRONG><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">1) renomear o diretório "C:\OpenSSL-Win32\bin\sefaz\intermediaria" (caso queira ter um backup, pois o certificado de AC intermediária é mantido nessa estrutura)</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">2) <SPAN style="font-size: 8pt">seguir os passos no arquivo "r</SPAN><SPAN style="font-size: 8pt">oteiro de geração de certificados A1.txt</SPAN><SPAN style="font-size: 8pt">" que está dentro da pasta "sefaz" (no zip gerador_certificados_sefaz_v2.zip)</SPAN><SPAN style="font-size: 8pt">), usando o comando</SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN  class="ms-rteFontFace-2" style="font-family: courier, monospace"></SPAN><SPAN  class="ms-rteFontFace-2" style="font-family: courier, monospace">perl CA-acsefazsp.pl -newsefazsp​</SPAN><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt">3) o certificado de AC intermediária é gerado na forma de estrutura de diretório em "</SPAN>C:\OpenSSL-Win32\bin\sefaz\intermediaria<SPAN style="font-size: 8pt">" sendo usado para assinar os certificados finais</SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt">4) após gerado o certificado da AC intermediária, gerar um certificado final para teste. Instalar o certificado final, verificar se o certificado de AC intemediaria está contido na cadeia e se contém as informações conforme configurado antes da geração. Extrair arquivo .cer do certificado de AC intermediária e<SPAN></SPAN> <STRONG  class="ms-rteForeColor-2" style="color: red;text-decoration: underline">instalar em todos os servidores</STRONG> onde o certificado final deverá ser reconhecido.</SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><STRONG style="font-size: 8pt">III) Para gerar certificados de AC raiz</STRONG><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><DIV><BR/></DIV><DIV>1) seguir passos idênticos a III (AC intermediária) usando folder "raiz" ao invés de "intermediaria" e o comando abaixo</DIV></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-family: courier, monospace">perl CA-acsefazsp.pl -newca</SPAN><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">2) Após gerar o certificado raiz, deve-se gerar novo certificado de AC intermediária e final</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><STRONG>IV) Para gerar nova LCR</STRONG><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><STRONG><BR/></STRONG></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt">1) geralmente a LCR criada por esse procedimento irá expirar na mesma data do certificado de AC intermediária. Se for esse o caso, a nova LCR deve ser gerada logo após o novo certificado de AC intermediária (o script irá usar a assinatura do certificado corrente para assinar a LCR)</SPAN><SPAN style="font-size: 8pt"></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt">2) fazer cópia do conteúdo das pastas abaixo, caso queira um backup</SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">C:\OpenSSL-Win32\bin\sefaz\certificados\crl (atualmente usado, aponta para a versão intermediaria)<BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">C:\OpenSSL-Win32\bin\sefaz\intermediaria\crl</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">C:\OpenSSL-Win32\bin\sefaz\raiz\crl<BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">3) gerar a nova LCR usando o comando </DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN  class="ms-rteFontFace-2" style="font-family: courier, monospace"></SPAN><SPAN  class="ms-rteFontFace-2" style="font-family: courier, monospace">perl CA-acsefazsp.pl -newclr​</SPAN><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">4) copiar a LCR gerada nas pastas citadas no passo 2 para os servidores de LCR. Por exemplo:  http://spointerdes01.intra.fazenda.sp.gov.br/aplicativos/nfce/crl (logar na spointerdes01 via RemoteDesktop e atualizar o arquivo em "D:\Inetpub\internetnew\aplicativos\nfce\crl")</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><STRONG>V) Para testar um novo certificado</STRONG><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">WebSite:</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">1) <SPAN style="font-size: 8pt">o novo certificado final </SPAN><SPAN style="font-size: 8pt">deve ter sido instalado na máquina onde rodará o teste; os novos certificados de AC raiz (se houver) e intermediária (se houver) deverão estar instalados na máquina do IIS</SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">2) tentar abrir um site seguro (no IIS, configurar opções SSL para "Required") usando o novo certificado</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">WebService:</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">2) o assinador de XML deve ser configurado com o novo certificado final (projeto "AssinadorNFCe" no Visual Studio)</DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><BR/></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)">3) no So<SPAN style="font-size: 8pt">apUI, instalar o novo certificado final (ver http://etc.intra.fazenda.sp.gov.br/sites/cds_equipe/Wiki%20CDS/FerramentasNFCe.aspx</SPAN><SPAN style="font-size: 8pt">) e submeter uma requisição usando o novo certificado.</SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><SPAN style="font-size: 8pt"><BR/></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><P style="margin: 0px 0px 10px;line-height: 1.6"><STRONG>Extras: </STRONG></P><P style="margin: 0px 0px 10px;line-height: 1.6"><STRONG>1) Criação de Certificados usando o KeyStore Explorer</STRONG></P><BLOCKQUOTE  dir="ltr" style="margin-right: 0px"><P style="margin: 0px 0px 10px;line-height: 1.6">Caso seja necessário criar certificados para testes no SoapUI, é possível fazer isso usando (entre outros) o SW "KeyStore Explorer" (<A  href="http://keystore-explorer.sourceforge.net/" style="color: rgb(0, 114, 198);text-decoration: none">http://keystore-explorer.sourceforge.net/</A>). Os passos para gerar um conjunto de certificados com 3 níveis são:</P><OL><LI><STRONG>Criar novo certificado raiz</STRONG><SPAN></SPAN> (caso não exista): opção "Create New KeyStore", tipo PKCS #12</LI><LI>Opção "generate key pair" (gera chave auto-assinada)</LI><LI>Completar com dados da AC Raiz (nome, organização, local, estado, país,..)</LI><LI>Importante: selecionar "Add Extension" e adicionar "Basic Constraints" setando "Subject is CA" (Path Lenght deixar vazio)</LI><LI>Exportar .cer (right click, export, certificate chain, header only, .x509, nomear como raiz.cer por exemplo)</LI><LI>Salvar como raiz.p12 p.exemplo</LI><LI><STRONG>Criar novo certificado intermediário</STRONG> (caso não exista): repetir passos 1 a 6, salvar como intermediario.p12 p.ex</LI><LI>Right-click, generate CSR (salvar como intermediario.csr p.ex)</LI><LI>Import trusted certificate, selecionar raiz.cer, aceitar certificado</LI><LI><U>Abrir raiz.p12</U>:</LI><LI>Right-click, sign, sign CSR, selecionar intermediario.csr</LI><LI>Ainda na janela anterior, Add Extension, Basic Constraint, "Subject is CA" (path lenght vazio)</LI><LI>Salvar como "CA-raiz-reply.p7r" p.ex</LI><LI><U>De volta no intermediario.p12</U>:</LI><LI>right-click, "import CA Reply", selecionar CA-raiz-reply.p7r</LI><LI>gerar intermediario.cer (export, certificate chain, header only, .X509)</LI><LI><STRONG>Criar novo certificado do teste</STRONG>: repetir passos 1 a 6, salvar como teste.p12 p.ex</LI><LI>Right-click, generate CSR (salvar como teste.csr p.ex)</LI><LI>import trusted certificate, selecionar raiz.cer, aceitar certificado</LI><LI>import trusted certificate, selecionar intermediario.cer</LI><LI><U>Abrir intermediario.p12</U>:</LI><LI>Right-click, sign, sign CSR, selecionar intermediario.csr</LI><LI>Ainda na janela anterior, Add Extension, Basic Constraint, "Subject is CA" (path lenght vazio)</LI><LI>Salvar como "CA-interm-reply.p7r" p.ex</LI><LI><U>De volta no teste.p12</U>:</LI><LI>right-click, "import CA Reply", selecionar CA-interm-reply.p7r</LI><LI>gerar teste.cer (export, certificate chain, header only, .X509)</LI><LI><STRONG>Instalando certificados</STRONG>: instalar primeiro o raiz.cer, depois o intermediario.cer, por último o teste.cer</LI><LI>Verificar no mmc.exe se os certificados estão instalados nos locais corretos (raiz, intermediario, pessoal)</LI><LI><STRONG>Usando o certificado de teste</STRONG>: para ser aceito na NFC-e, é preciso adicionar a chave do raiz.cer na <STRONG>ValidaçãoA</STRONG> , caso contrário ocorrerá o erro 285 (<FONT  color="#008000"  size="2"  face="Consolas"><FONT  color="#008000"  size="2"  face="Consolas"><FONT  color="#008000"  size="2"  face="Consolas">Certificado Raiz difere da "ICP-Brasil"</FONT></FONT></FONT>)</LI><LI>No SoapUI, seguir instruções específicas em http://etc.intra.fazenda.sp.gov.br/sites/cds_equipe/Wiki%20CDS/FerramentasNFCe.aspx​</LI></OL><P style="margin: 0px 0px 10px;line-height: 1.6"> ​<BR/></P></BLOCKQUOTE><SPAN style="font-size: 8pt"></SPAN></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"></DIV><DIV style="color: rgb(68, 68, 68);font-family: &amp;quot;font-size: 13px;font-style: normal;font-weight: 400;letter-spacing: normal;text-align: start;text-indent: 0px;text-transform: none;white-space: normal;word-spacing: 0px;background-color: rgba(255, 255, 255, 0.85)"><P style="margin: 0px 0px 10px;line-height: 1.6"><STRONG>2) Criação de Certificados auto-assinado localhost</STRONG></P><BLOCKQUOTE  dir="ltr" style="margin-right: 0px"><P style="margin: 0px 0px 10px;line-height: 1.6">Caso seja necessário criar certificados 'localhost'  para uso no bindings do IIS:</P>1. Rodar como admin no Powershell: &gt;New-SelfSignedCertificate -DnsName "localhost" -CertStoreLocation "cert:\LocalMachine\My"<BR/></BLOCKQUOTE><BLOCKQUOTE  dir="ltr" style="margin-right: 0px">2. Copiar o certificado criado (em local machine) para a pasta de chaves raiz<BR/></BLOCKQUOTE><BLOCKQUOTE  dir="ltr" style="margin-right: 0px">3. Na área 'secure', opção 'bindings', selecionar o certificado 'loccalhost' criado (o nome do binding deve ser também 'localhost')<BR/></BLOCKQUOTE><SPAN  id="ms-rterangecursor-end"  aria-hidden="true"></SPAN></DIV><BR  class="Apple-interchange-newline"/>


